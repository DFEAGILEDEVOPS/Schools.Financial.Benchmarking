@using SFB.Web.Common
@using SFB.Web.UI.Helpers.Constants
@using SFB.Web.UI.Helpers.Enums
@model SFB.Web.UI.Models.SchoolViewModel
@{
    ViewBag.Title = "Schools Financial Benchmarking";
    ViewBag.pageClass = "school-detail";
}

@section InsideHead{
    <link href="~/public/assets/print/school-print.css" media="print" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="~/node_modules/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="~/node_modules/leaflet-fullscreen/dist/leaflet.fullscreen.css" />

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="~/node_modules/leaflet/dist/leaflet.js"></script>
    <script src='~/node_modules/leaflet-fullscreen/dist/Leaflet.fullscreen.min.js'></script>

}

@section BMListBannerContent
{
    <div id="benchmarkBasket"></div>
}

@section BackButtonContent{
    @Html.Partial("Partials/BackToHomeLink")
}

@if (!Model.IsReturnsComplete || !Model.WorkforceDataPresent || Model.HasNoTeacherData || Model.HasNoPupilData)
{
    <div class="panel panel-border-wide orange-warning mt-1">
        <div class="shared-icon-wrapper">
            <i class="icon icon-important shared-icon">
                <span class="visually-hidden">Warning</span>
            </i>
        </div>
        <div class="combined-warnings">
            @if (!Model.IsReturnsComplete)
            {
                <p>
                    This school doesn't have a complete set of financial data for this period
                </p>
            }

            @if (!Model.WorkforceDataPresent)
            {
                <p>
                    This school doesn't have a complete set of workforce data for this period
                </p>
            }

            @if (Model.HasNoTeacherData)
            {
                <p>
                    We can’t show charts with per teacher values because they weren't supplied within these finance returns
                </p>
            }

            @if (Model.HasNoPupilData)
            {
                <p>
                    We can’t show charts with per pupil values because they weren't supplied within these finance returns
                </p>
            }
        </div>
    </div>
}

<h1 class="heading-xlarge page-heading">@Model.Name</h1>

@if (!Model.IsReturnsDNS)
{
    <div class="grid-row hide-in-print returns-complete" id="benchmarkControlsPlaceHolder"></div>
}
else
{
    <div class="grid-row hide-in-print returns-incomplete" id="benchmarkControlsPlaceHolder"></div>
}

<div class="grid-row">
    <div class="column-half">
        <div class="metadata-school-detail font-xsmall">
            <dl class="metadata-school-detail__dl">
                @SchoolDetailField("Address:", $"<a class=\"sfb_gtm_address\" rel=\"external noopener noreferrer\" target=\"_blank\" href=\"https://www.google.co.uk/maps?q={Model.Name},{Model.Address}\">{Model.Address}<span class=\"visually-hidden\">GoogleMaps link opens in a new window</span></a>")
                @if (!string.IsNullOrEmpty(Model.PhoneNumber))
                {
                    @SchoolDetailField("Telephone number:", $"<a class=\"sfb_gtm_tel\" href=\"tel: {Model.PhoneNumber}\" aria-label=\"Call telephone number {Model.PhoneNumber}\">{Model.PhoneNumber}</a>")
                }
                @SchoolDetailField("Local authority:", $"<a href=\"/SchoolSearch/Search?nameId=&suggestionUrn=&trustnameid=&trustsuggestionUrn=&locationorpostcode=&LocationCoordinates=&openOnly=true&lacodename={Model.La.ToString()}&SelectedLocalAuthorityId=&searchtype=search-by-la-code-name\" aria-label=\"View schools in {Model.LaName}\">{Model.LaName}</a>")
                @SchoolDetailField("School type:", Model.Type)
                @if (Model.OverallPhase != Model.Phase)
                {
                    @SchoolDetailField("School overall phase:", Model.OverallPhase)
                }
                @SchoolDetailField("School phase:", Model.Phase)
                @SchoolDetailField("Number of pupils:", Model.TotalPupils.ToString())
                <dt class="metadata-school-detail__dt"><abbr title="Unique reference number" aria-label="Unique reference number">URN</abbr>:</dt>
                <dd class="metadata-school-detail__dd bold">@Model.Id</dd>
                @if (Model.OfstedRating == "0")
                {
                    @SchoolDetailField("Ofsted rating:", Model.OfstedRatingText)
                }
                else
                {
                    @SchoolDetailFieldFormatted("Ofsted rating:",
                                    "<span class=\"rating rating-{0}\"> {0} </span><span class=\"rating-text\"> {1} </span>" +
                                    "<span class=\"ofsted-divider\" aria-hidden=\"true\">| </span>" +
                                    "<a target=\"_blank\" rel=\"external noopener noreferrer\" class=\"font16-ext-link\" href=\"https://reports.ofsted.gov.uk/inspection-reports/find-inspection-report/provider/ELS/{2}\">Ofsted report <span class=\"visually-hidden\">Opens in a new window</span></a>" +
                                    "<br><span class=\"font-xxsmall not-bold\">Inspected {3}</span>",
                                    Model.OfstedRating, Model.OfstedRatingText, Model.Id.ToString(), Model.OfstedInspectionDate)
                }
                <dt class="metadata-school-detail__dt"><abbr title="Local authority establishment code" aria-label="Local authority establishment code">LAESTAB</abbr>:</dt>
                <dd class="metadata-school-detail__dd bold">@Model.LaEstab</dd>
                @SchoolDetailField("Age range of pupils:", Model.AgeRange)
                @SchoolDetailField("Headteacher's name:", Model.HeadTeachFullName)
                @SchoolDetailField("Has sixth form:", Model.IsPost16)
                @SchoolDetailField("Has nursery:", Model.HasNursery)
                @SchoolDetailField("Date of opening:", Model.OpenDate)
                @SchoolDetailField("Date of closure:", Model.CloseDate)
                @SchoolDetailFieldFormatted("School website:", "<a rel=\"external noopener noreferrer\" class=\"font16-ext-link sfb_gtm_website\" target=\"_blank\" href=\"{0}\">{0} <span class=\"visually-hidden\">Opens in a new window</span></a>", Model.SchoolWebSite)
                @if (Model.IsMAT)
                {
                    @SchoolDetailFieldFormatted("Belongs to:", "<a href=\"/trust?companyNo={0}\">{1}</a>", Server.UrlEncode(Model.CompanyNo.ToString()), Model.TrustName)
                }
                @DataSourcesField()

            </dl>
            <div style="display: inline-block" class="mb-1">
                <a href="~/Help/DataQueries">Do you have a query about this school's data?</a>
            </div>
            <input type="hidden" id="la" value="@Model.La" />
            <input type="hidden" id="estab" value="@Model.Estab" />
        </div>
    </div>
    <div class="column-half">
        <details open>
            <summary class="map hide-in-print">
                <span class="summary font-xsmall">Show map</span>
            </summary>
            <div class="panel panel-border-narrow map">
                <a href="#post-map-content" class="skip-map">Skip the map</a>
                <div id="SchoolLocationMap" class="mtl school-location-map" title="An Azure map of the school's location" aria-label="An Azure map of the school's location"></div>
            </div>
        </details>
        @*<div class="govuk-box-highlight">
            <h3 class="heading-large mt-0 pt-0">
                <a target="_blank" rel="external noopener noreferrer" class="govuk-box-highlight__link" href="https://www.gov.uk/government/publications/deals-for-schools/deals-for-schools">Deals for schools<span class="visuallyhidden"> Opens in a new window</span></a>
            </h3>
            <p class="font-xsmall pb-0 mb-0">
                Find a range of cost-saving deals for schools assessed for compliance with procurement regulations and ease of use by the DfE
            </p>
        </div>*@
    </div>
    <div id="post-map-content" class="column-full hide-in-print">
        <div class="column-one-third no-padding">
            <div class="download">
                <a class="no-underline bold-xsmall sfb_gtm_csv_school" href="/school/download?urn=@Model.Id" aria-label="Download data for @Model.Name in Excel spreadsheet. Opens in a new window">
                    <img class="icon" alt="Opens in a new window" src="~/public/assets/images/icons/icon-file-download.png" />
                    Download data for this school
                </a>
            </div>
        </div>
        <div class="column-one-third no-padding">
            <div class="print">
                <button class="no-underline link-button no-underline bold-xsmall black" onclick="DfE.Views.SchoolDetailsViewModel.PrintPage()" aria-label="Print page for @Model.Name">
                    <img class="icon" alt="" src="~/public/assets/images/icons/icon-print.png" />
                    Print page
                </button>
            </div>
        </div>
    </div>
</div>

@Html.Partial("Partials/FinancialSummaryFields")

<a name="charts"></a>
<nav id="tabs" class="tabs" role="navigation">
    <ol role="tablist">
        <li class="@(ViewBag.Tab == RevenueGroupType.Expenditure ? "active" : "") hide-in-print" role="tab">
            <button class="a-button" onclick="DfE.Views.SchoolDetailsViewModel.TabChange(@Model.Id,'@RevenueGroupType.Expenditure')">@RevenueGroupNames.EXPENDITURE</button>
        </li>
        <li class="@(ViewBag.Tab == RevenueGroupType.Income ? "active" : "") hide-in-print" role="tab">
            <button class="a-button" onclick="DfE.Views.SchoolDetailsViewModel.TabChange(@Model.Id,'@RevenueGroupType.Income')">@RevenueGroupNames.INCOME</button>
        </li>
        <li class="@(ViewBag.Tab == RevenueGroupType.Balance ? "active" : "") hide-in-print" role="tab">
            <button class="a-button" onclick="DfE.Views.SchoolDetailsViewModel.TabChange(@Model.Id,'@RevenueGroupType.Balance')">@RevenueGroupNames.BALANCE</button>
        </li>
        <li class="@(ViewBag.Tab == RevenueGroupType.Workforce ? "active" : "") hide-in-print" role="tab">
            <button class="a-button" onclick="DfE.Views.SchoolDetailsViewModel.TabChange(@Model.Id,'@RevenueGroupType.Workforce')">@RevenueGroupNames.WORKFORCE</button>
        </li>
    </ol>
</nav>
<div class="sticky-div sticky-chart-controls">
    @Html.Partial("Partials/ValueSelect", Model)
    @Html.Partial("Partials/ChartGroups", Model.ChartGroups)
    @if (Model.EstablishmentType == EstablishmentType.Academies && Model.HistoricalFinancialDataModels.Last().IsMAT)
    {
        Html.RenderPartial("Partials/CentralFinancing");
    }
</div>
<div class="charts-section">
    <div class="grid-row">
        <div>
            <div class="column-full font-xsmall chartTable hide-in-print">
                <button type="button" style="display: @Html.Raw(ViewBag.ChartFormat == ChartFormat.Tables ? "block" : "none")" class="view-charts-tables charts a-button" onclick="DfE.Views.SchoolDetailsViewModel.ToggleChartsTables('Charts')"><img class="icon" src="~/public/assets/images/icons/icon-chart.png" alt="" /><span> View as charts</span></button>
                <button type="button" style="display: @Html.Raw(ViewBag.ChartFormat == ChartFormat.Tables ? "none" : "block")" class="view-charts-tables tables a-button" onclick="DfE.Views.SchoolDetailsViewModel.ToggleChartsTables('Tables')"><img class="icon" src="~/public/assets/images/icons/icon-list.png" alt="" /><span> View as tables</span></button>
            </div>
            <div class="column-full font-xsmall hide-in-print">
                <button type="button" class="back-to-main-chart-group-button" onclick="DfE.Views.HistoricalCharts.ResetGrouping()">
                    <span><</span>
                    <span class="underline">All <span class="js-parent-group">expenditure</span> charts</span>
                </button>
            </div>
        </div>
    </div>
    <div class="historical-charts-list">
        @Html.Partial("Partials/Chart", Model)
    </div>
</div>

<a href="#pagetop" class="page-top hide-in-print">Back to top</a>


@helper SchoolDetailFieldFormatted(string name, string formatString, params string[] args)
{
    if (args != null)
    {
        if (args.Any(string.IsNullOrEmpty))
        {
            return;
        }

        var formatted = string.Format(formatString, args);
        @SchoolDetailField(name, formatted)
    }
}

@helper SchoolDetailField(string name, string value)
{
    if (!string.IsNullOrEmpty(value))
    {
        var htmlValue = new MvcHtmlString(value);

        <dt class="metadata-school-detail__dt">@name</dt>
        <dd class="metadata-school-detail__dd bold">@htmlValue</dd>
    }
}

@helper DataSourcesField()
{
    <dt class="metadata-school-detail__dt">Data from other <br>services:</dt>
    <dd class="metadata-school-detail__dd bold">
        @if (ViewBag.SptReportExists)
        {
            <a rel="external noopener noreferrer" class="font16-ext-link sfb_gtm_spt" target="_blank" href="https://www.compare-school-performance.service.gov.uk/school/@Model.Id">School performance tables<span class="visuallyhidden"> Opens in a new window</span></a>
            <span class="seperator" aria-hidden="true">&nbsp; | &nbsp;</span>
        }
        <a rel="external noopener noreferrer" class="font16-ext-link sfb_gtm_more_info" target="_blank" href="https://get-information-schools.service.gov.uk/Establishments/Establishment/Details/@Model.Id">Get more information<span class="visuallyhidden"> Opens in a new window</span></a>
    </dd>
}

@section ViewScripts {
    <script src="~/node_modules/d3/d3.min.js"></script>
    <script src="~/node_modules/c3/c3.min.js"></script>
    <script src="~/node_modules/lodash/lodash.min.js"></script>

    <script>
        DfE.Views.SchoolDetailsViewModel = new SchoolDetailsViewModel(@Model.Id, @Model.Lat, @Model.Lng, '@Model.HasCoordinates', '@ViewBag.ChartFormat', '@ViewBag.UnitType', '@(System.Configuration.ConfigurationManager.AppSettings["AzureMapsAPIKey"])');
    </script>
}